# GPR岩石検出シミュレーター 取扱説明書

## 1. 概要
本プログラムは、月面地中レーダー（GPR: Ground Penetrating Radar）による岩石検出プロセスを数値的に模倣するシミュレーターです。

真の岩石分布（べき乗則）に対し、レーダー方程式に基づく信号減衰（幾何減衰および媒質減衰）を適用することで、**「深部に行くほど小さな岩石が見えなくなる（検出限界以下の信号となる）」現象**を再現します。また、その結果として観測される「見かけのべき指数（Apparent Slope）」が深度とともにどのように変化するかを解析します。

主なモデルベース：Chang'e-3 LPR (Lunar Penetrating Radar) Channel 2 (500 MHz帯)

## 2. 動作環境
以下のPythonライブラリが必要です。

* **numpy**: 数値計算
* **pandas**: データフレーム操作
* **matplotlib**: グラフ描画
* **os**: ディレクトリ操作（標準ライブラリ）
* **datetime**: タイムスタンプ取得（標準ライブラリ）

### インストールコマンド例
```bash
pip install numpy pandas matplotlib
```

## 3. 使用方法

### 実行手順
1.  コードを `gpr_simulation.py` 等のファイル名で保存します。
2.  ターミナル（またはコマンドプロンプト）で以下のコマンドを実行します。

```bash
python gpr_simulation.py
```

3.  実行後、プロンプトが表示されますので、シミュレーションしたい**真のべき指数 ($r$)** を入力してください。

```text
--- 岩石見逃しモデル シミュレーション ---
真のべき指数(r)を入力してください (例: 2.5): 2.8
```
* 入力値は、累積個数分布 $N(>D) \propto D^{-r}$ の指数 $r$ です。
* 一般的な月面岩石の $r$ は 2.0 〜 3.5 程度です。
* 数値を入力せずにEnterを押すと、デフォルト値 ($2.5$) が使用されます。

### 出力
実行が完了すると、カレントディレクトリに `output_r{入力値}_{日時}` というフォルダが作成され、その中に結果ファイルが保存されます。

## 4. 出力ファイルの詳細

生成されたフォルダ内には以下のファイルが含まれます。

### データファイル (CSV)
| ファイル名 | 内容 |
| :--- | :--- |
| **parameters.txt** | シミュレーションに使用したパラメータ設定値（周波数、誘電率、減衰定数など）のログ。 |
| **truth_rocks.csv** | 生成された全岩石の真のデータ（直径、深度）。「神の視点」でのデータです。 |
| **simulated_detection.csv** | レーダー方程式適用後のデータ。受信電力、RCS、検出フラグ（`is_detected`）が付与されています。 |
| **depth_analysis_results.csv** | 深度範囲ごとの解析結果。各深度までの岩石を使って計算した「見かけの傾き」が記録されています。 |

### グラフ画像 (PNG)
| ファイル名 | 内容 |
| :--- | :--- |
| **csfd_all_detected.png** | 検出された全岩石の累積サイズ頻度分布（CSFD）プロット。赤い破線はフィッティング結果を示します。 |
| **r_evolution_by_depth.png** | **[重要]** 解析深度範囲（横軸）と見かけのべき指数 $r$（縦軸）の関係図。<br>深部を含めるほど、小さな岩石の見逃しが増え、$r$ が真の値（赤点線）よりも小さく（緩やかに）なる様子が確認できます。 |

## 5. アルゴリズムと物理モデル詳細

本コードでは `RadarConfig`, `RockModel`, `Analyzer` の3つのクラスで処理を行っています。

### A. 岩石生成モデル (`RockModel.generate_rocks`)
* **分布則**: 累積個数 $N(>D) \propto D^{-r}$ に従うよう、逆関数法を用いて乱数を生成します。
* **空間配置**: 深さ $0 \sim 20\text{m}$ の範囲にランダムに配置します。

### B. レーダー断面積 (RCS) の計算 (`RockModel.calculate_rcs_db`)
岩石のサイズ $D$ と媒質中の波長 $\lambda_g$ の関係により、散乱領域を分けて計算します。

1.  **レイリー領域 ($D < \lambda_g/2$)**:
    * 散乱断面積 $\sigma$ は $D^6$ に比例します（波長に対して物体が小さい場合、反射は急激に弱くなります）。
2.  **光学領域 ($D \ge \lambda_g/2$)**:
    * 幾何学的断面積 $\pi (D/2)^2$ に反射係数を乗じた値となります。

### C. レーダー方程式 (`RockModel.apply_radar_equation`)
受信電力 $P_r$ [dBm] は以下の式に基づいて計算されます。

$$
P_r = P_t + G_{sys} + \sigma_{dB} - L_{spread} - L_{atten} + C_{\lambda}
$$

* **幾何減衰 ($L_{spread}$)**: 往復伝搬のため距離の4乗に比例して減衰します（$40 \log_{10} R$）。
* **媒質減衰 ($L_{atten}$)**: レゴリス中を伝搬する際の損失です（$2 \times \alpha \times R$）。
    * デフォルト設定: $\alpha = 0.5 \text{ dB/m}$ (往復で $1.0 \text{ dB/m}$)
* **検出判定**: $P_r$ がノイズフロア（デフォルト $-90 \text{ dBm}$）を超えている場合のみ「検出（Detected）」と判定されます。

## 6. パラメータのカスタマイズ

シミュレーション条件を変更したい場合は、コード冒頭の `RadarConfig` クラス内の変数を直接編集してください。

```python
class RadarConfig:
    def __init__(self):
        # 周波数 (Hz)
        self.FREQ = 500e6  
        
        # 送信電力 (dBm) : 検出感度を上げたい場合は大きくする
        self.TX_POWER_DBM = 62.0
        
        # ノイズフロア (dBm) : 検出限界。小さいほど感度が良い
        self.NOISE_FLOOR_DBM = -90.0
        
        # 媒質の減衰定数 (dB/m) : 片道の減衰量
        # 月の海（チタン豊富）では大きく、高地では小さい傾向がある
        self.ATTENUATION_DB_M = 0.5 
        
        # レゴリスの比誘電率
        self.EPSILON_R_REG = 3.1
        
        # シミュレーション最大深度 (m)
        self.MAX_DEPTH = 20.0
```

## 7. トラブルシューティング

* **エラー: `ZeroDivisionError` や `log(0)` 系の警告**
    * 岩石生成数が極端に少ない、または深度0mの岩石が生成された場合に発生することがあります。コード内では `+ 0.1` 等の微小値を加えて回避していますが、岩石総数 `TOTAL_ROCKS` を増やすことで安定します。
* **グラフの傾きがおかしい**
    * 生成された岩石数が少ないと、統計的なばらつきによりフィッティングがうまくいかない場合があります。`TOTAL_ROCKS` を $100,000$ 程度に増やして試してください。